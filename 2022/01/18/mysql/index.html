<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>mysql | Xiang&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="事务隔离级别(图文详解)什么是事务?事务是逻辑上的一组操作，要么都执行，要么都不执行。 事务最经典也经常被拿出来说例子就是转账了。假如小明要给小红转账1000元，这个转账会涉及到两个关键操作就是：将小明的余额减少1000元，将小红的余额增加1000元。万一在这两个操作之间突然出现错误比如银行系统崩溃，导致小明余额减少而小红的余额没有增加，这样就不对了。事务就是保证这两个关键操作要么都成功，要么都要">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql">
<meta property="og:url" content="https://losserlong.github.io/2022/01/18/mysql/index.html">
<meta property="og:site_name" content="Xiang&#39;s Blog">
<meta property="og:description" content="事务隔离级别(图文详解)什么是事务?事务是逻辑上的一组操作，要么都执行，要么都不执行。 事务最经典也经常被拿出来说例子就是转账了。假如小明要给小红转账1000元，这个转账会涉及到两个关键操作就是：将小明的余额减少1000元，将小红的余额增加1000元。万一在这两个操作之间突然出现错误比如银行系统崩溃，导致小明余额减少而小红的余额没有增加，这样就不对了。事务就是保证这两个关键操作要么都成功，要么都要">
<meta property="og:locale">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118173945.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118173951.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118173954.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118173957.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118173959.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118174001.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118174002.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118174005.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118174008.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118174009.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118174011.png">
<meta property="article:published_time" content="2022-01-18T08:31:34.000Z">
<meta property="article:modified_time" content="2022-01-18T10:09:26.665Z">
<meta property="article:author" content="Xiang">
<meta property="article:tag" content="mysql">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118173945.png">
  
    <link rel="alternate" href="/atom.xml" title="Xiang&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Xiang&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://losserlong.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-mysql" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/01/18/mysql/" class="article-date">
  <time datetime="2022-01-18T08:31:34.000Z" itemprop="datePublished">2022-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      mysql
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="事务隔离级别-图文详解"><a href="#事务隔离级别-图文详解" class="headerlink" title="事务隔离级别(图文详解)"></a>事务隔离级别(图文详解)</h1><h2 id="什么是事务"><a href="#什么是事务" class="headerlink" title="什么是事务?"></a>什么是事务?</h2><p>事务是逻辑上的一组操作，要么都执行，要么都不执行。</p>
<p>事务最经典也经常被拿出来说例子就是转账了。假如小明要给小红转账1000元，这个转账会涉及到两个关键操作就是：将小明的余额减少1000元，将小红的余额增加1000元。万一在这两个操作之间突然出现错误比如银行系统崩溃，导致小明余额减少而小红的余额没有增加，这样就不对了。事务就是保证这两个关键操作要么都成功，要么都要失败。</p>
<h3 id="常用的事务控制语法"><a href="#常用的事务控制语法" class="headerlink" title="常用的事务控制语法"></a>常用的事务控制语法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- 事务开始</span><br><span class="line">begin;</span><br><span class="line">- 事务提交，提交后就会写入物理磁盘中去</span><br><span class="line">commit;</span><br><span class="line">- 事务回滚，事务提交后，无法回滚</span><br><span class="line">rollback;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="事务的四大特性（ACID）"><a href="#事务的四大特性（ACID）" class="headerlink" title="事务的四大特性（ACID）"></a>事务的四大特性（ACID）</h2><p><img src="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118173945.png" alt="image-20211231191231001"></p>
<ol>
<li><strong><font color='red'>原子性（atomicity）</font>：</strong> <strong>事务是最小的执行单位，不允许分割。</strong>事务的原子性确保动作要么全部完成，要么完全不起作用；</li>
<li><strong><font color='red'>一致性（consistency）</font>：</strong> <strong>执行事务前后，数据保持一致</strong>，例如转账业务中，无论事务是否成功，转账者和收款人的总额应该是不变的；</li>
<li><strong><font color='red'>隔离性（isolation）</font>：</strong> 并发访问数据库时，一个用户的事务不被其他事务所干扰，<strong>各并发事务之间数据库是独立的；</strong></li>
<li><strong><font color='red'>持久性（durability）</font>：</strong> <strong>一个事务被提交之后。它对数据库中数据的改变是持久的</strong>，即使数据库发生故障也不应该对其有任何影响。</li>
</ol>
<h2 id="关闭mysql的事务自动提交"><a href="#关闭mysql的事务自动提交" class="headerlink" title="关闭mysql的事务自动提交"></a>关闭mysql的事务自动提交</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET autocommit = 0|1|ON|OFF;</span><br></pre></td></tr></table></figure>

<p>对取值的说明：</p>
<p>值为 0 和值为 OFF：关闭事务自动提交。如果关闭自动提交，用户将会一直处于某个事务中，只有提交或回滚后才会结束当前事务，重新开始一个新事务。<br>值为 1 和值为 ON：开启事务自动提交。如果开启自动提交，则每执行一条 SQL 语句，事务都会提交一次。</p>
<h2 id="数据库的隔离级别"><a href="#数据库的隔离级别" class="headerlink" title="数据库的隔离级别"></a>数据库的隔离级别</h2><h3 id="事务隔离级别的定义"><a href="#事务隔离级别的定义" class="headerlink" title="事务隔离级别的定义"></a>事务隔离级别的定义</h3><p>事务指定一个隔离级别，该隔离级别<strong>定义一个事务必须与由其他事务进行的资源或数据更改相隔离的程度。</strong>隔离级别从允许的并发副作用（例如，脏读或幻读的角度进行描述。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- 查看隔离级别,8.0版本之前的，用SELECT @@tx_isolation</span><br><span class="line">select @@transaction_isolation;</span><br><span class="line"></span><br><span class="line">- 修改隔离级别</span><br><span class="line">set session transaction isolation level  READ UNCOMMITTED;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="隔离级别的分类"><a href="#隔离级别的分类" class="headerlink" title="隔离级别的分类"></a>隔离级别的分类</h3><p><strong>读未提交(READ-UNCOMMITTED)：</strong>A事务操作后没有执行commit提交命令，但是B事务也能察觉到A操作的数据变化，此时B重新查询，则能查询出A操作后的最新数据，但是当A事务rollback回滚后，A操作的数据其实没有变化，这时候B处的数据就变成了脏数据(容易导致脏读情形产生)</p>
<p>设置隔离级别为读未提交</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- 设置隔离级别</span><br><span class="line">set session transaction isolation level    read uncommitted;</span><br><span class="line"> - 查看隔离级别</span><br><span class="line">select  @@transaction_isolation;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>



<p><strong>读已提交(不可重复读 read committed)oracle默认的隔离级别</strong>:读已提交，表示只有执行了commit命令后，才能得知数据的变化，A修改了数据，没有提交，B不会察觉到数据的变化。这样虽然会避免脏读，但是会出现，当A读取某一条数据时候，B正在对该数据进行操作(修改)，但是B操作并没有结束，因此此时数据并没有发生变化，但是A在B事务提交前已经执行完了，那就会出现数据不一致现象，这种问题叫做不可重复读。</p>
<p>设置隔离级别为读已提交</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> - 设置隔离级别</span><br><span class="line">set session transaction isolation level    read committed;</span><br><span class="line">  - 查看隔离级别</span><br><span class="line">select  @@transaction_isolation;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>可重复读(repeatable read mysql 的默认隔离级别)</strong></p>
<p>可重复读与不可重复读很容易搞混淆，<strong>可重复读侧重于有没有进行行增加减少，也就是新增和删除，而不可重复读侧重于修改操作，不影响行数。</strong>可重复读是采用锁行形式，因为是锁行，所以无法保证对行数的操作限制隔离，只能保证当前锁住的行隔离影响。</p>
<p><strong>串行化</strong></p>
<p>最可靠的事务隔离级别。“写”会加“写锁”，“读”会加“读锁”。当出现读写锁冲突的时候，后访问的事务必须等前一个事务执行完成，才能继续执行。事务 100% 隔离，可避免脏读、不可重复读、幻读的发生。因为串行化是锁表，因此虽然隔离级别最高，但是消耗资源最大</p>
<p>mysql数据库默认的事务隔离级别是<strong>可重复读（REPEATABLE-READ ）</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select @@transaction_isolation;</span><br><span class="line">+-------------------------+</span><br><span class="line">| @@transaction_isolation |</span><br><span class="line">+-------------------------+</span><br><span class="line">| REPEATABLE-READ         |</span><br><span class="line">+-------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>修改数据库的事务隔离级别为<strong>不可重复读 READ-UNCOMMITTED</strong> </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select @@transaction_isolation;</span><br><span class="line">+-------------------------+</span><br><span class="line">| @@transaction_isolation |</span><br><span class="line">+-------------------------+</span><br><span class="line">| READ-UNCOMMITTED        |</span><br><span class="line">+-------------------------+</span><br></pre></td></tr></table></figure>



<p>这下面是MySQL8的事务隔离级别，MySQL5的话可重读读，还是会出现幻读</p>
<table>
<thead>
<tr>
<th>事务隔离级别</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody><tr>
<td>读未提交（read-uncommitted）</td>
<td>是</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>不可重复读（read-committed）</td>
<td>否</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>可重复读（repeatable-read）</td>
<td>否</td>
<td>否</td>
<td><strong>否</strong></td>
</tr>
<tr>
<td>串行化（serializable）</td>
<td>否</td>
<td>否</td>
<td>否</td>
</tr>
</tbody></table>
<h2 id="并发事务带来的问题"><a href="#并发事务带来的问题" class="headerlink" title="并发事务带来的问题"></a>并发事务带来的问题</h2><p>在典型的应用程序中，多个事务并发运行，经常会操作相同的数据来完成各自的任务（多个用户对统一数据进行操作）。并发虽然是必须的，但可能会导致以下的问题。</p>
<ul>
<li><strong>脏读（Dirty read）:</strong> 当一个事务正在访问数据并且对数据进行了修改，而这种修改还没有提交到数据库中，这时另外一个事务也访问了这个数据，然后使用了这个数据。因为这个数据是还没有提交的数据，然后后一个事务进行回滚，将数据变成之前的值，那么前一个事务读到的这个数据是“脏数据”，依据“脏数据”所做的操作可能是不正确的。<font color='red'><strong>（读取未提交数据）</strong></font></li>
</ul>
<table>
<thead>
<tr>
<th align="center">时间顺序</th>
<th>转账事务</th>
<th>取款事务</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td></td>
<td>开始事务</td>
</tr>
<tr>
<td align="center">2</td>
<td>开始事务</td>
<td></td>
</tr>
<tr>
<td align="center">3</td>
<td></td>
<td>查询账户余额为2000元</td>
</tr>
<tr>
<td align="center">4</td>
<td></td>
<td>取款1000元，余额被更改为1000元</td>
</tr>
<tr>
<td align="center">5</td>
<td>查询账户余额为1000元（产生脏读）</td>
<td></td>
</tr>
<tr>
<td align="center">6</td>
<td></td>
<td>取款操作发生未知错误，事务回滚，余额变更为2000元</td>
</tr>
<tr>
<td align="center">7</td>
<td>转入2000元，余额被更改为3000元（脏读的1000+2000）</td>
<td></td>
</tr>
<tr>
<td align="center">8</td>
<td>提交事务</td>
<td></td>
</tr>
<tr>
<td align="center">备注</td>
<td>按照正确逻辑，此时账户余额应该为4000元</td>
<td></td>
</tr>
</tbody></table>
<p>注意：这里要修改mysql的事务隔离级别为<strong>不可重复读（ READ-UNCOMMITTED ）</strong></p>
<p>account表中的原始状态</p>
<p><img src="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118173951.png" alt="image-20211231200932520"></p>
<p><img src="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118173954.png" alt="image-20211231201320508"></p>
<p><img src="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118173957.png" alt="image-20211231201342895"></p>
<p><img src="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118173959.png" alt="image-20211231201534124"></p>
<p><img src="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118174001.png" alt="image-20211231201641543"></p>
<p><img src="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118174002.png" alt="image-20220101115134146"></p>
<p><img src="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118174005.png" alt="image-20220101115237036"></p>
<ul>
<li><strong>丢失修改（Lost to modify）:</strong> 指在一个事务读取一个数据时，另外一个事务也访问了该数据，那么在第一个事务中修改了这个数据后，第二个事务也修改了这个数据。这样第一个事务内的修改结果就被丢失，因此称为丢失修改。 例如：事务1读取某表中的数据A=20，事务2也读取A=20，事务1修改A=A-1，事务2也修改A=A-1，最终结果A=19，事务1的修改被丢失。</li>
</ul>
<ul>
<li><strong>不可重复读（Unrepeatableread）:</strong> 指在一个事务内多次读同一数据。在这个事务还没有结束时，另一个事务也访问该数据。那么，在第一个事务中的两次读数据之间，由于第二个事务的修改导致第一个事务两次读取的数据可能不太一样。这就发生了在一个事务内两次读到的数据是不一样的情况，因此称为不可重复读。**<font color='red'>（前后多次读取，数据内容不一致）</font>**</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118174008.png" alt="image-20220101144933767"></p>
<img src="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118174009.png" alt="image-20220101150808461" />

<p><img src="https://cdn.jsdelivr.net/gh/losserlong/pictures/20220118174011.png" alt="image-20220101150929999"></p>
<ul>
<li><strong>幻读（Phantom read）:</strong> 幻读与不可重复读类似。它发生在一个事务（T1）读取了几行数据，接着另一个并发事务（T2）插入了一些数据时。在随后的查询中，第一个事务（T1）就会发现<strong>多了一些原本不存在的记录</strong>，就好像发生了幻觉一样，所以称为幻读。**<font color='red'>（前后多次读取，数据总量不一致）</font>**</li>
</ul>
<p>绿衣捧砚催题卷，红袖添香伴读书</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://losserlong.github.io/2022/01/18/mysql/" data-id="ckyjz3y6b0005awvf46mv141o" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2022/01/16/juc/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">newpapername</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/JUC/" rel="tag">JUC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/JUC/" style="font-size: 10px;">JUC</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/01/18/mysql/">mysql</a>
          </li>
        
          <li>
            <a href="/2022/01/16/juc/">newpapername</a>
          </li>
        
          <li>
            <a href="/2022/01/16/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Xiang<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>